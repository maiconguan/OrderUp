<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Order Up!</title>

<style>
/* ================== RESET ================== */
* {
  box-sizing: border-box;
  font-family: "Segoe UI", sans-serif;
}
body {
  margin: 0;
  background: linear-gradient(135deg, #60a5fa, #a78bfa);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ================== COMMON ================== */
.hidden { display: none !important;; }
button {
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 700;
  background: #22c55e;
  color: white;
}
button:hover { transform: scale(1.05); }

/* ================== CARD ================== */
.card {
  padding: 10px 14px;
  background: white;
  border-radius: 12px;
  border: 2px solid #60a5fa;
  cursor: grab;
  user-select: none;
  font-weight: 600;
  transition: all 0.3s;
}
.card.correct {
  background: #22c55e;
  color: white;
}
.card.wrong {
  background: #ef4444;
  color: white;
  animation: shake 0.4s 2;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-6px); }
  100% { transform: translateX(0); }
}


/* animation state */
.card.fly-down {
  transform: translateY(80px) scale(.9);
  opacity: .7;
}
.card.fly-up {
  transform: translateY(-80px) scale(.9);
  opacity: .7;
}

/* ================== SETUP ================== */
#setup {
  background: white;
  padding: 24px;
  border-radius: 20px;
  width: 360px;
}
#setup input, select {
  width: 100%;
  padding: 10px;
  margin-bottom: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

/* ================== GAME ================== */
#game {
  background: white;
  padding: 20px;
  width: 95vw;
  max-width: 900px;
  border-radius: 20px;
}

#topCards, #dropZone {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  min-height: 70px;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 14px;
}

#topCards {
  background: #f1f5f9;
}
#dropZone {
  background: #e0f2fe;
}

#vnMeaning {
  font-weight: 700;
  color: #065f46;
  margin-bottom: 10px;
}


/* ================== MODAL ================== */
#modal {
  /* Thi·∫øt l·∫≠p ph·ªß k√≠n m√†n h√¨nh */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* M√†u n·ªÅn m·ªù */
  
  /* CƒÉn gi·ªØa */
  display: flex;
  justify-content: center; /* CƒÉn gi·ªØa ngang */
  align-items: center;     /* CƒÉn gi·ªØa d·ªçc */
  
  z-index: 1000; /* ƒê·∫£m b·∫£o n·ªïi tr√™n c√°c ph·∫ßn t·ª≠ kh√°c */
}

#modalContent {
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  max-width: 90%; /* ƒê·ªÉ kh√¥ng b·ªã tr√†n tr√™n ƒëi·ªán tho·∫°i */
}

#gameScreen {
    display: none;
  }

  #topBar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 14px;
  }
  #progressWrapper {
  width: 100%;
  margin: 12px auto 16px;
  text-align: center;
}

#progressText {
  font-weight: 700;
  margin-bottom: 6px;
  color: #1f2937;
}

.progress-bar {
  height: 14px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(135deg, #22c55e, #4ade80);
  transition: width 0.35s ease;
}

.flying{
  position:fixed;
  z-index:9999;
  pointer-events:none;
  transition:
    transform .5s cubic-bezier(.4,1.4,.6,1),
    opacity .4s;
}

.btn-study {
  /* M√†u s·∫Øc v√† h√¨nh d√°ng */
  background: linear-gradient(135deg, #6e8efb, #a777e3); /* M√†u gradient xanh t√≠m tr·∫ª trung */
  color: white;
  padding: 12px 28px;
  font-size: 18px;
  font-weight: 600;
  border: none;
  border-radius: 50px; /* Bo tr√≤n ho√†n to√†n t·∫°o c·∫£m gi√°c th√¢n thi·ªán */
  cursor: pointer;
  margin: 10px 10px;
  
  /* ƒê·ªï b√≥ng nh·∫π t·∫°o ƒë·ªô n·ªïi (3D) */
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  
  /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† */
  transition: all 0.3s ease;
  outline: none;
  display: inline-block;
  text-align: center;
}

/* Hi·ªáu ·ª©ng khi di chu·ªôt v√†o (Hover) */
.btn-study:hover {
  transform: translateY(-3px); /* N√∫t bay l√™n nh·∫π */
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); /* B√≥ng ƒë·∫≠m h∆°n */
  filter: brightness(1.1); /* S√°ng h∆°n m·ªôt ch√∫t */
}

/* Hi·ªáu ·ª©ng khi click v√†o (Active) */
.btn-study:active {
  transform: translateY(2px); /* N√∫t l√∫n xu·ªëng khi b·∫•m */
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.container {
  display: flex;
  justify-content: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
  align-items: center;     /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc (n·∫øu container c√≥ chi·ªÅu cao) */
  height: auto;           /* V√≠ d·ª• v·ªÅ chi·ªÅu cao */
}



</style>
</head>

<body>

<!-- ========== SETUP ========== -->
<div id="setup">
  <h2>üß© ORDER UP!!!</h2>
   <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
  <input id="username" placeholder="Your name" />
 <select id="sourceSelect">
    <option value="recent">‚ú® M·ªõi nh·∫•t</option>
    <option value="random">üé≤ Ng·∫´u nhi√™n</option>
  </select>
  <div>
  <label>Ph·∫°m vi t·ª´ card s·ªë:</label>
    <input type="number" id="startRow" value="1" min="1" />
  </div>
  <div>
  <label>ƒë·∫øn card s·ªë: </label>  
    <input type="number" id="endRow" value="1000" min="1" />
  </div>
  </div>

  <label>S·ªë c√¢u: <span id="countLabel">10</span></label>
  <input type="range" id="limitWord" min="1" max="100" value="10" />
 
  <div class="container">
      <button class="btn-study" onclick="startGame()">üöÄ Start</button>
  </div>
  <label id="errorMsg"></label>
</div>

<!-- ========== GAME ========== -->


<div id="game" class="hidden">
  <div id="gameScreen">
  <div id="topBar">
    <div>‚è±Ô∏è <span id="timeEl">0</span></div>
    <div id="progressText">0 / 0</div>
    <div>‚≠ê ƒêi·ªÉm: <span id="scoreEl">0</span></div>
  </div>

      <div id="progressWrapper">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
</div>

  <div id="vnMeaning"></div>
  <div id="topCards"></div>
  <div id="dropZone"></div>
  <button id="nextBtn" class="btn-study" class="hidden" onclick="nextSentence()">Next</button>
</div>

<!-- ========== MODAL ========== -->
<div id="modal" class="hidden">
  <div id="modalContent"></div>
</div>

<script>
/* ================== CONFIG ================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbxFwY9moTt7fMEa2JEeNe2RUQgDeg7sXGxLWD4qvDGNkSJ-dh1Ab-G4vsMOSk9r0twK/exec';

/* ================== STATE ================== */
let sentences = [];
let index = 0;
let score = 0;
let failedOnce = new Set();
let startTime = 0;
let timerInterval = null;

/* ================== SETUP ================== */
limitWord.oninput = () => countLabel.innerText = limitWord.value;

const startRow = document.getElementById('startRow');
const endRow = document.getElementById('endRow');
const errorMsg = document.getElementById('errorMsg');

/* ================== FETCH ================== */
async function startGame() {
  
  const user = username.value.trim() || '';
  const limit = +parseInt(limitWord.value, 10);
  const mode = sourceSelect.value;
  const start = +parseInt(startRow.value, 10);
  const end = +parseInt(endRow.value, 10);

  errorMsg.innerText='‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...';
  let words = await fetchWords(user, limit, mode, start,end);

  if (words.length < 1) {
    errorMsg.innerText='‚ùå Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ b·∫Øt ƒë·∫ßu.';
    return;
  }

  words.forEach((w) => {
    if(w.example != '')
      sentences.push(parseExample(w));
  });
  sentences.sort(() => Math.random() - 0.5);


  setup.classList.add("hidden");
  game.classList.remove("hidden");

  restartGame();
}

async function fetchWords(user, total, mode, start, end) {

  const url =
    `${API_URL}?owner=${encodeURIComponent(user)}` +
    `&limit=${total}` +
    `&mode=${mode}` +
    `&startRow=${start}` + 
    `&endRow=${end}`;

  const res = await fetch(url);
  if (!res.ok) {
    errorMsg.innerText='‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server';
    throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server');
  }

  const json = await res.json();
  if (!json.success){ 
    errorMsg.innerText='‚ùå L·ªói: ' + json.error;
    throw new Error(json.error);
  }

  return json.data;
}



/* ================== PARSE EXAMPLE ================== */
function parseExample(w) {
  const match = w.example.match(/(.+?)\s*\((.+)\)/);
  return {
    id: w.en,
    en: match[1].trim(),
    vn: match[2].trim(),
    words: match[1].trim().split(" ")
  };
}

/* ================== GAME LOGIC ================== */
function loadSentence() {
  topCards.innerHTML = "";
  dropZone.innerHTML = "";
  vnMeaning.innerText = "";
  nextBtn.classList.add("hidden");

  const s = sentences[index];
  const shuffled = [...s.words].sort(() => Math.random() - 0.5);

  shuffled.forEach(word => {
    const card = createCard(word);
    topCards.appendChild(card);
  });
}

/* ================== CARD ================== */
function createCard(text){
  const card = document.createElement('div');
  card.className = 'card';
  card.textContent = text;

  card.addEventListener('click', () => moveCard(card));
  return card;
}

function moveCard(card){
  const fromPool = card.parentElement === topCards;

  //
  /* 1. L·∫•y v·ªã tr√≠ b·∫Øt ƒë·∫ßu */
  const start = card.getBoundingClientRect();
  /* 2. X√°c ƒë·ªãnh v·ªã tr√≠ ƒë√≠ch = cu·ªëi c√¢u */
  const temp = document.createElement('span');
  if(fromPool) {
    dropZone.appendChild(temp);
  }
  else {
    topCards.appendChild(temp);
  }
  const end = temp.getBoundingClientRect();
  temp.remove();

  /* 3. Clone card */
  const clone = card.cloneNode(true);
  clone.classList.add('flying');

  clone.style.left = start.left + 'px';
  clone.style.top  = start.top + 'px';
  clone.style.width = start.width + 'px';
  clone.style.height = start.height + 'px';

  /* 4. ·∫®n card g·ªëc t·∫°m th·ªùi */
  card.style.visibility = 'hidden';
  document.body.appendChild(clone);


  /* 5. Animate */
  requestAnimationFrame(()=>{
    clone.style.transform = `
      translate(${end.left - start.left}px,
                ${end.top  - start.top}px)`;
  });

  /* 6. K·∫øt th√∫c animation */
  setTimeout(()=>{
    //card.classList.remove('flying');
    clone.remove();
    card.style.visibility = '';

    if(fromPool){
      dropZone.appendChild(card); // xu·ªëng d∆∞·ªõi
      checkIfDone();
    } else {
      topCards.appendChild(card);     // bay l√™n tr√™n
    }
  },300);





  // add animation class
  // card.classList.add(fromPool ? 'fly-down' : 'fly-up');

  // // sau animation -> move DOM
  // setTimeout(() => {
  //   card.classList.remove('fly-down','fly-up');

  //   if(fromPool){
  //     dropZone.appendChild(card); // xu·ªëng d∆∞·ªõi
  //     checkIfDone();
  //   } else {
  //     topCards.appendChild(card);     // bay l√™n tr√™n
  //   }

  // }, 300);
}


/* ================== CHECK ================== */
function checkIfDone() {
  const cards = [...dropZone.children];
  if (cards.length !== sentences[index].words.length) return;

  const userSentence = cards.map(c => c.innerText).join(" ");
  const correct = sentences[index].en;

  if (userSentence === correct) {
    cards.forEach(c => c.classList.add("correct"));
    vnMeaning.innerText = sentences[index].vn;
    speak(correct);

    if (!failedOnce.has(index)) {
      score++;
      scoreEl.textContent = score;
    }

    
    goToNextQuestion();

  } else {
    cards.forEach(c => {
      c.classList.add("wrong");
      setTimeout(() => c.classList.remove("wrong"), 800);
    });
    failedOnce.add(index);
  }
}

/* ================== NEXT ================== */
function goToNextQuestion(){
  if (index < (sentences.length - 1)){
    nextBtn.classList.remove("hidden");
  }
  else {
    nextSentence();
  }
}

function nextSentence() {
  index++;
  updateProgress();

  if (index >= sentences.length) 
    return showResult();

  loadSentence();
}

function updateProgress() {
  const percent = index === 0
    ? 0
    : Math.round((index / sentences.length) * 100);

  document.getElementById('progressText').innerText =
    `${index} / ${sentences.length}`;

  document.getElementById('progressFill').style.width =
    `${percent}%`;
}

function formatTime(totalSeconds) {
  totalSeconds = Math.floor(totalSeconds);

  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = totalSeconds % 60;

  // < 1 ph√∫t
  if (totalSeconds < 60) {
    return `${s}s`;
  }

  // < 1 gi·ªù
  if (totalSeconds < 3600) {
    return `${m}:${String(s).padStart(2, '0')}`;
  }

  // >= 1 gi·ªù
  return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
}

function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);

  timerInterval = setInterval(() => {
    const t = Math.floor((Date.now() - startTime) / 1000);
    timeEl.textContent = formatTime(t);
  }, 1000);
}

/* ================== RESULT ================== */
function showResult() {
  clearInterval(timerInterval);

  modal.classList.remove("hidden");
  modalContent.innerHTML = `
    
    <h3>üéâ Ho√†n th√†nh</h3>
    <p>‚è±Ô∏è Th·ªùi gian: ${timeEl.textContent}</p>
    <p>‚≠ê ƒêi·ªÉm s·ªë: ${score}/${sentences.length}</p>
     <div class="container">
    <button class="btn-study" onclick="restartGame()">üîÑ Ch∆°i l·∫°i</button>
    <button class="btn-study" onclick="location.reload()">‚ú® T·∫°o m·ªõi</button>
    </div>
  `;
}
function showModal(title, msg) {
  const time = Math.floor((Date.now() - startTime) / 1000);
  modal.classList.remove("hidden");
  modalContent.innerHTML = `
    <p><h3>${title}</h3></p>
    <p>${msg}</p>
    <div class="container">
      <button class="btn-study" onclick="location.reload()">‚ú® T·∫°o m·ªõi</button>
    </div>
    </div>
  `;
}

function restartGame() {
  if(sentences.length < 1) {
    showModal('C·∫£nh b√°o', '‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫°o game do t·ª´ b·∫°n ch·ªçn kh√¥ng c√≥ v√≠ d·ª•!!!');
    return;
  }

  modal.classList.add("hidden");
  index = 0;
  score = 0;
  scoreEl.textContent = score;
  gameScreen.style.display = "block";
  loadSentence();
  startTimer();
  updateProgress();
};


/* ================== TTS ================== */
function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  speechSynthesis.speak(u);
}
</script>

</body>
</html>
